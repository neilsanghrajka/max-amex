# Database Setup with Drizzle

This guide outlines how to work with the Drizzle ORM in this project.

## Initial Setup

The project was set up using `drizzle-kit`. The initial schema was created by introspecting the database.

1.  **Configuration**: The `drizzle.config.ts` file is configured to output migration files to `src/db/migrations` and read all schema definitions from `src/db/schema/`.

2.  **Bootstrapping**: The initial schema was generated using the `pull` command.

    ```bash
    npx drizzle-kit pull
    ```

    > **Note:** We must use `npx` instead of `pnpx` to run `drizzle-kit` commands to avoid dependency resolution issues.

3.  **Schema Relocation**: The generated schema files were then moved from `src/db/migrations` to `src/db/schema` to establish the code as the single source of truth.

## Directory Structure

We landed on a structure that keeps all database-related code organized within the `src` directory.

```
my-app/
├── drizzle.config.ts
├── src/
│   ├── db/
│   │   ├── migrations/      # SQL migrations generated by Drizzle Kit
│   │   ├── schema/          # Your TypeScript schema definitions
│   │   │   ├── index.ts     # Exports all schemas
│   │   │   └── *.ts         # Schema for each table
│   │   └── db.ts            # Drizzle client instance
│   └── ...
└── ...
```

## Usage: Adding a New Table

From now on, the workflow is "schema-first". You write the schema in code, and Drizzle generates the SQL.

1.  **Add a New Schema File**: Create a new file for your table in `src/db/schema/`, for example `src/db/schema/users.ts`.

2.  **Update Schema Index**: Export the new table from `src/db/schema/index.ts`.

    ```typescript
    // src/db/schema/index.ts
    export * from './smsWebhooks';
    export * from './users'; // Add this line
    ```

3.  **Generate Migration**: Create the SQL migration file based on your schema changes.

    ```bash
    npx drizzle-kit generate
    ```

4.  **Apply Migration**: Apply the newly generated migration to your database.

    ```bash
    npx drizzle-kit migrate
    ``` 

## Querying the Database

To run queries, import the `db` instance from `@/db` and the required tables from your schema files.

All standard Drizzle methods (`select`, `insert`, `update`, `delete`, etc.) are available on the `db` object.

### Example

Here is an example of how to fetch all records from the `smsWebhooks` table in a server-side component or API route.

```typescript
import { db } from '@/db';
import { smsWebhooks } from '@/db/schema';

export async function getWebhooks() {
  const allWebhooks = await db.select().from(smsWebhooks);
  return allWebhooks;
}
``` 